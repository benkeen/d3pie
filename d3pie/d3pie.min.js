/*!
* d3pie
* @author Ben Keen
* @version 0.1.9
* @date April 2015
* @repo http://github.com/benkeen/d3pie
*/
!function(a,b){if("function"==typeof define&&define.amd){var c;try{c=require("d3")}catch(d){c=a.d3}define([],function(){return b(c)})}else"object"==typeof exports?module.exports=b(require("d3")):a.d3pie=b(a.d3)}(this,function(a){var b="d3pie",c="0.1.6",d=0,e={header:{title:{text:"",color:"#333333",fontSize:18,font:"arial"},subtitle:{text:"",color:"#666666",fontSize:14,font:"arial"},location:"top-center",titleSubtitlePadding:8},footer:{text:"",color:"#666666",fontSize:14,font:"arial",location:"left"},size:{canvasHeight:500,canvasWidth:500,pieInnerRadius:"0%",pieOuterRadius:null},data:{sortOrder:"none",ignoreSmallSegments:{enabled:!1,valueType:"percentage",value:null},smallSegmentGrouping:{enabled:!1,value:1,valueType:"percentage",label:"Other",color:"#cccccc"},content:[]},labels:{outer:{format:"label",hideWhenLessThanPercentage:null,pieDistance:30},inner:{format:"percentage",hideWhenLessThanPercentage:null},mainLabel:{color:"#333333",font:"arial",fontSize:10},percentage:{color:"#dddddd",font:"arial",fontSize:10,decimalPlaces:0},value:{color:"#cccc44",font:"arial",fontSize:10},lines:{enabled:!0,style:"curved",color:"segment"},truncation:{enabled:!1,truncateLength:30},formatter:null},effects:{load:{effect:"default",speed:1e3},pullOutSegmentOnClick:{effect:"bounce",speed:300,size:10},highlightSegmentOnMouseover:!0,highlightLuminosity:-.2},tooltips:{enabled:!1,type:"placeholder",string:"",placeholderParser:null,styles:{fadeInSpeed:250,backgroundColor:"#000000",backgroundOpacity:.5,color:"#efefef",borderRadius:2,font:"arial",fontSize:10,padding:4}},misc:{colors:{background:null,segments:["#2484c1","#65a620","#7b6888","#a05d56","#961a1a","#d8d23a","#e98125","#d0743c","#635222","#6ada6a","#0c6197","#7d9058","#207f33","#44b9b0","#bca44a","#e4a14b","#a3acb2","#8cc3e9","#69a6f9","#5b388f","#546e91","#8bde95","#d2ab58","#273c71","#98bf6e","#4daa4b","#98abc5","#cc1010","#31383b","#006391","#c2643f","#b0a474","#a5a39c","#a9c2bc","#22af8c","#7fcecf","#987ac6","#3d3b87","#b77b1c","#c9c2b6","#807ece","#8db27c","#be66a2","#9ed3c6","#00644b","#005064","#77979f","#77e079","#9c73ab","#1f79a7"],segmentStroke:"#ffffff"},gradient:{enabled:!1,percentage:95,color:"#000000"},canvasPadding:{top:5,right:5,bottom:5,left:5},pieCenterOffset:{x:0,y:0},cssPrefix:null},callbacks:{onload:null,onMouseoverSegment:null,onMouseoutSegment:null,onClickSegment:null}},f={initialCheck:function(b){var c=b.cssPrefix,d=b.element,e=b.options;if(!a||!a.hasOwnProperty("version"))return console.error("d3pie error: d3 is not available"),!1;if(!(d instanceof HTMLElement||d instanceof SVGElement))return console.error("d3pie error: the first d3pie() param must be a valid DOM element (not jQuery) or a ID string."),!1;if(!/[a-zA-Z][a-zA-Z0-9_-]*$/.test(c))return console.error("d3pie error: invalid options.misc.cssPrefix"),!1;if(!g.isArray(e.data.content))return console.error("d3pie error: invalid config structure: missing data.content property."),!1;if(0===e.data.content.length)return console.error("d3pie error: no data supplied."),!1;for(var f=[],h=0;h<e.data.content.length;h++)"number"!=typeof e.data.content[h].value||isNaN(e.data.content[h].value)?console.log("not valid: ",e.data.content[h]):e.data.content[h].value<=0?console.log("not valid - should have positive value: ",e.data.content[h]):f.push(e.data.content[h]);return b.options.data.content=f,!0}},g={addSVGSpace:function(b){var c=b.element,d=b.options.size.canvasWidth,e=b.options.size.canvasHeight,f=b.options.misc.colors.background,g=a.select(c).append("svg:svg").attr("width",d).attr("height",e);return"transparent"!==f&&g.style("background-color",function(){return f}),g},whenIdExists:function(a,b){var c=1,d=1e3,e=setInterval(function(){document.getElementById(a)&&(clearInterval(e),b()),c>d&&clearInterval(e),c++},1)},whenElementsExist:function(a,b){var c=1,d=1e3,e=setInterval(function(){for(var f=!0,g=0;g<a.length;g++)if(!document.getElementById(a[g])){f=!1;break}f&&(clearInterval(e),b()),c>d&&clearInterval(e),c++},1)},shuffleArray:function(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a},processObj:function(a,b,c){return"string"==typeof b?g.processObj(a,b.split("."),c):1===b.length&&void 0!==c?(a[b[0]]=c,a[b[0]]):0===b.length?a:g.processObj(a[b[0]],b.slice(1),c)},getDimensions:function(a){var b=document.getElementById(a),c=0,d=0;if(b){var e=b.getBBox();c=e.width,d=e.height}else console.log("error: getDimensions() "+a+" not found.");return{w:c,h:d}},rectIntersect:function(a,b){var c=b.x>a.x+a.w||b.x+b.w<a.x||b.y+b.h<a.y||b.y>a.y+a.h;return!c},getColorShade:function(a,b){a=String(a).replace(/[^0-9a-f]/gi,""),a.length<6&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]),b=b||0;for(var c="#",d=0;3>d;d++){var e=parseInt(a.substr(2*d,2),16);e=Math.round(Math.min(Math.max(0,e+e*b),255)).toString(16),c+=("00"+e).substr(e.length)}return c},initSegmentColors:function(a){for(var b=a.options.data.content,c=a.options.misc.colors.segments,d=[],e=0;e<b.length;e++)b[e].hasOwnProperty("color")?d.push(b[e].color):d.push(c[e]);return d},applySmallSegmentGrouping:function(a,b){var c;"percentage"===b.valueType&&(c=i.getTotalPieSize(a));for(var d=[],e=[],f=0,g=0;g<a.length;g++)if("percentage"===b.valueType){var h=a[g].value/c*100;if(h<=b.value){e.push(a[g]),f+=a[g].value;continue}a[g].isGrouped=!1,d.push(a[g])}else{if(a[g].value<=b.value){e.push(a[g]),f+=a[g].value;continue}a[g].isGrouped=!1,d.push(a[g])}return e.length&&d.push({color:b.color,label:b.label,value:f,isGrouped:!0,groupedData:e}),d},showPoint:function(a,b,c){a.append("circle").attr("cx",b).attr("cy",c).attr("r",2).style("fill","black")},isFunction:function(a){var b={};return a&&"[object Function]"===b.toString.call(a)},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)}},h=function(){var a,b,c,d,e,f,g=arguments[0]||{},i=1,j=arguments.length,k=!1,l=Object.prototype.toString,m=Object.prototype.hasOwnProperty,n={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},o={isFunction:function(a){return"function"===o.type(a)},isArray:Array.isArray||function(a){return"array"===o.type(a)},isWindow:function(a){return null!==a&&a===a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return null===a?String(a):n[l.call(a)]||"object"},isPlainObject:function(a){if(!a||"object"!==o.type(a)||a.nodeType)return!1;try{if(a.constructor&&!m.call(a,"constructor")&&!m.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(b){return!1}var c;for(c in a);return void 0===c||m.call(a,c)}};for("boolean"==typeof g&&(k=g,g=arguments[1]||{},i=2),"object"==typeof g||o.isFunction(g)||(g={}),j===i&&(g=this,--i),i;j>i;i++)if(null!==(a=arguments[i]))for(b in a)c=g[b],d=a[b],g!==d&&(k&&d&&(o.isPlainObject(d)||(e=o.isArray(d)))?(e?(e=!1,f=c&&o.isArray(c)?c:[]):f=c&&o.isPlainObject(c)?c:{},g[b]=h(k,f,d)):void 0!==d&&(g[b]=d));return g},i={toRadians:function(a){return a*(Math.PI/180)},toDegrees:function(a){return a*(180/Math.PI)},computePieRadius:function(a){var b=a.options.size,c=a.options.misc.canvasPadding,d=b.canvasWidth-c.left-c.right,e=b.canvasHeight-c.top-c.bottom;"pie-center"!==a.options.header.location&&(e-=a.textComponents.headerHeight),a.textComponents.footer.exists&&(e-=a.textComponents.footer.h),e=0>e?0:e;var f,g,h=(e>d?d:e)/3;if(null!==b.pieOuterRadius)if(/%/.test(b.pieOuterRadius)){g=parseInt(b.pieOuterRadius.replace(/[\D]/,""),10),g=g>99?99:g,g=0>g?0:g;var i=e>d?d:e;if("none"!==a.options.labels.outer.format){var j=2*parseInt(a.options.labels.outer.pieDistance,10);i-j>0&&(i-=j)}h=Math.floor(i/100*g)/2}else h=parseInt(b.pieOuterRadius,10);/%/.test(b.pieInnerRadius)?(g=parseInt(b.pieInnerRadius.replace(/[\D]/,""),10),g=g>99?99:g,g=0>g?0:g,f=Math.floor(h/100*g)):f=parseInt(b.pieInnerRadius,10),a.innerRadius=f,a.outerRadius=h},getTotalPieSize:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].value;return b},sortPieData:function(a){var b=a.options.data.content,c=a.options.data.sortOrder;switch(c){case"none":break;case"random":b=g.shuffleArray(b);break;case"value-asc":b.sort(function(a,b){return a.value<b.value?-1:1});break;case"value-desc":b.sort(function(a,b){return a.value<b.value?1:-1});break;case"label-asc":b.sort(function(a,b){return a.label.toLowerCase()>b.label.toLowerCase()?1:-1});break;case"label-desc":b.sort(function(a,b){return a.label.toLowerCase()<b.label.toLowerCase()?1:-1})}return b},getPieTranslateCenter:function(a){return"translate("+a.x+","+a.y+")"},calculatePieCenter:function(a){var b=a.options.misc.pieCenterOffset,c=a.textComponents.title.exists&&"pie-center"!==a.options.header.location,d=a.textComponents.subtitle.exists&&"pie-center"!==a.options.header.location,e=a.options.misc.canvasPadding.top;c&&d?e+=a.textComponents.title.h+a.options.header.titleSubtitlePadding+a.textComponents.subtitle.h:c?e+=a.textComponents.title.h:d&&(e+=a.textComponents.subtitle.h);var f=0;a.textComponents.footer.exists&&(f=a.textComponents.footer.h+a.options.misc.canvasPadding.bottom);var g=(a.options.size.canvasWidth-a.options.misc.canvasPadding.left-a.options.misc.canvasPadding.right)/2+a.options.misc.canvasPadding.left,h=(a.options.size.canvasHeight-f-e)/2+e;g+=b.x,h+=b.y,a.pieCenter={x:g,y:h}},rotate:function(a,b,c,d,e){e=e*Math.PI/180;var f=Math.cos,g=Math.sin,h=(a-c)*f(e)-(b-d)*g(e)+c,i=(a-c)*g(e)+(b-d)*f(e)+d;return{x:h,y:i}},translate:function(a,b,c,d){var e=i.toRadians(d);return{x:a+c*Math.sin(e),y:b-c*Math.cos(e)}},pointIsInArc:function(a,b,c){var d=c.innerRadius()(b),e=c.outerRadius()(b),f=c.startAngle()(b),g=c.endAngle()(b),h=a.x*a.x+a.y*a.y,i=Math.atan2(a.x,-a.y);return i=0>i?i+2*Math.PI:i,h>=d*d&&e*e>=h&&i>=f&&g>=i}},j={add:function(a,b,c){var d=j.getIncludes(c),e=a.options.labels,f=a.svg.insert("g","."+a.cssPrefix+"labels-"+b).attr("class",a.cssPrefix+"labels-"+b),g=f.selectAll("."+a.cssPrefix+"labelGroup-"+b).data(a.options.data.content).enter().append("g").attr("id",function(c,d){return a.cssPrefix+"labelGroup"+d+"-"+b}).attr("data-index",function(a,b){return b}).attr("class",a.cssPrefix+"labelGroup-"+b).style("opacity",0),h={section:b,sectionDisplayType:c};d.mainLabel&&g.append("text").attr("id",function(c,d){return a.cssPrefix+"segmentMainLabel"+d+"-"+b}).attr("class",a.cssPrefix+"segmentMainLabel-"+b).text(function(a,b){var c=a.label;return e.formatter?(h.index=b,h.part="mainLabel",h.value=a.value,h.label=c,c=e.formatter(h)):e.truncation.enabled&&a.label.length>e.truncation.truncateLength&&(c=a.label.substring(0,e.truncation.truncateLength)+"..."),c}).style("font-size",e.mainLabel.fontSize+"px").style("font-family",e.mainLabel.font).style("fill",e.mainLabel.color),d.percentage&&g.append("text").attr("id",function(c,d){return a.cssPrefix+"segmentPercentage"+d+"-"+b}).attr("class",a.cssPrefix+"segmentPercentage-"+b).text(function(b,c){var d=k.getPercentage(a,c,a.options.labels.percentage.decimalPlaces);return e.formatter?(h.index=c,h.part="percentage",h.value=b.value,h.label=d,d=e.formatter(h)):d+="%",d}).style("font-size",e.percentage.fontSize+"px").style("font-family",e.percentage.font).style("fill",e.percentage.color),d.value&&g.append("text").attr("id",function(c,d){return a.cssPrefix+"segmentValue"+d+"-"+b}).attr("class",a.cssPrefix+"segmentValue-"+b).text(function(a,b){return h.index=b,h.part="value",h.value=a.value,h.label=a.value,e.formatter?e.formatter(h,a.value):a.value}).style("font-size",e.value.fontSize+"px").style("font-family",e.value.font).style("fill",e.value.color)},positionLabelElements:function(b,c,d){j["dimensions-"+c]=[];var e=a.selectAll("."+b.cssPrefix+"labelGroup-"+c);e.each(function(d,e){var f=a.select(this).selectAll("."+b.cssPrefix+"segmentMainLabel-"+c),g=a.select(this).selectAll("."+b.cssPrefix+"segmentPercentage-"+c),h=a.select(this).selectAll("."+b.cssPrefix+"segmentValue-"+c);j["dimensions-"+c].push({mainLabel:null!==f.node()?f.node().getBBox():null,percentage:null!==g.node()?g.node().getBBox():null,value:null!==h.node()?h.node().getBBox():null})});var f=5,g=j["dimensions-"+c];switch(d){case"label-value1":a.selectAll("."+b.cssPrefix+"segmentValue-"+c).attr("dx",function(a,b){return g[b].mainLabel.width+f});break;case"label-value2":a.selectAll("."+b.cssPrefix+"segmentValue-"+c).attr("dy",function(a,b){return g[b].mainLabel.height});break;case"label-percentage1":a.selectAll("."+b.cssPrefix+"segmentPercentage-"+c).attr("dx",function(a,b){return g[b].mainLabel.width+f});break;case"label-percentage2":a.selectAll("."+b.cssPrefix+"segmentPercentage-"+c).attr("dx",function(a,b){return g[b].mainLabel.width/2-g[b].percentage.width/2}).attr("dy",function(a,b){return g[b].mainLabel.height})}},computeLabelLinePositions:function(b){b.lineCoordGroups=[],a.selectAll("."+b.cssPrefix+"labelGroup-outer").each(function(a,c){return j.computeLinePosition(b,c)})},computeLinePosition:function(a,b){var c,d,e,f,g=k.getSegmentAngle(b,a.options.data.content,a.totalSize,{midpoint:!0}),h=i.rotate(a.pieCenter.x,a.pieCenter.y-a.outerRadius,a.pieCenter.x,a.pieCenter.y,g),j=a.outerLabelGroupData[b].h/5,l=6,m=Math.floor(g/90),n=4;switch(2===m&&180===g&&(m=1),m){case 0:c=a.outerLabelGroupData[b].x-l-(a.outerLabelGroupData[b].x-l-h.x)/2,d=a.outerLabelGroupData[b].y+(h.y-a.outerLabelGroupData[b].y)/n,e=a.outerLabelGroupData[b].x-l,f=a.outerLabelGroupData[b].y-j;break;case 1:c=h.x+(a.outerLabelGroupData[b].x-h.x)/n,d=h.y+(a.outerLabelGroupData[b].y-h.y)/n,e=a.outerLabelGroupData[b].x-l,f=a.outerLabelGroupData[b].y-j;break;case 2:var o=a.outerLabelGroupData[b].x+a.outerLabelGroupData[b].w+l;c=h.x-(h.x-o)/n,d=h.y+(a.outerLabelGroupData[b].y-h.y)/n,e=a.outerLabelGroupData[b].x+a.outerLabelGroupData[b].w+l,f=a.outerLabelGroupData[b].y-j;break;case 3:var p=a.outerLabelGroupData[b].x+a.outerLabelGroupData[b].w+l;c=p+(h.x-p)/n,d=a.outerLabelGroupData[b].y+(h.y-a.outerLabelGroupData[b].y)/n,e=a.outerLabelGroupData[b].x+a.outerLabelGroupData[b].w+l,f=a.outerLabelGroupData[b].y-j}"straight"===a.options.labels.lines.style?a.lineCoordGroups[b]=[{x:h.x,y:h.y},{x:e,y:f}]:a.lineCoordGroups[b]=[{x:h.x,y:h.y},{x:c,y:d},{x:e,y:f}]},addLabelLines:function(b){var c=b.svg.insert("g","."+b.cssPrefix+"pieChart").attr("class",b.cssPrefix+"lineGroups").style("opacity",0),d=c.selectAll("."+b.cssPrefix+"lineGroup").data(b.lineCoordGroups).enter().append("g").attr("class",b.cssPrefix+"lineGroup"),e=a.svg.line().interpolate("basis").x(function(a){return a.x}).y(function(a){return a.y});d.append("path").attr("d",e).attr("stroke",function(a,c){return"segment"===b.options.labels.lines.color?b.options.colors[c]:b.options.labels.lines.color}).attr("stroke-width",1).attr("fill","none").style("opacity",function(a,c){var d=b.options.labels.outer.hideWhenLessThanPercentage,e=k.getPercentage(b,c,b.options.labels.percentage.decimalPlaces),f=null!==d&&d>e||""===b.options.data.content[c].label;return f?0:1})},positionLabelGroups:function(b,c){"none"!==b.options.labels[c].format&&a.selectAll("."+b.cssPrefix+"labelGroup-"+c).style("opacity",0).attr("transform",function(a,d){var e,f;if("outer"===c)e=b.outerLabelGroupData[d].x,f=b.outerLabelGroupData[d].y;else{var j=h(!0,{},b.pieCenter);if(b.innerRadius>0){var l=k.getSegmentAngle(d,b.options.data.content,b.totalSize,{midpoint:!0}),m=i.translate(b.pieCenter.x,b.pieCenter.y,b.innerRadius,l);j.x=m.x,j.y=m.y}var n=g.getDimensions(b.cssPrefix+"labelGroup"+d+"-inner"),o=n.w/2,p=n.h/4;e=j.x+(b.lineCoordGroups[d][0].x-j.x)/1.8,f=j.y+(b.lineCoordGroups[d][0].y-j.y)/1.8,e-=o,f+=p}return"translate("+e+","+f+")"})},fadeInLabelsAndLines:function(b){var c="default"===b.options.effects.load.effect?b.options.effects.load.speed:1;setTimeout(function(){var c="default"===b.options.effects.load.effect?400:1;a.selectAll("."+b.cssPrefix+"labelGroup-outer").transition().duration(c).style("opacity",function(a,c){var d=b.options.labels.outer.hideWhenLessThanPercentage,e=k.getPercentage(b,c,b.options.labels.percentage.decimalPlaces);return null!==d&&d>e?0:1}),a.selectAll("."+b.cssPrefix+"labelGroup-inner").transition().duration(c).style("opacity",function(a,c){var d=b.options.labels.inner.hideWhenLessThanPercentage,e=k.getPercentage(b,c,b.options.labels.percentage.decimalPlaces);return null!==d&&d>e?0:1}),a.selectAll("g."+b.cssPrefix+"lineGroups").transition().duration(c).style("opacity",1),g.isFunction(b.options.callbacks.onload)&&setTimeout(function(){try{b.options.callbacks.onload()}catch(a){}},c)},c)},getIncludes:function(a){var b=!1,c=!1,d=!1;switch(a){case"label":b=!0;break;case"value":c=!0;break;case"percentage":d=!0;break;case"label-value1":case"label-value2":b=!0,c=!0;break;case"label-percentage1":case"label-percentage2":b=!0,d=!0}return{mainLabel:b,value:c,percentage:d}},computeOuterLabelCoords:function(a){a.svg.selectAll("."+a.cssPrefix+"labelGroup-outer").each(function(b,c){return j.getIdealOuterLabelPositions(a,c)}),j.resolveOuterLabelCollisions(a)},resolveOuterLabelCollisions:function(a){if("none"!==a.options.labels.outer.format){var b=a.options.data.content.length;j.checkConflict(a,0,"clockwise",b),j.checkConflict(a,b-1,"anticlockwise",b)}},checkConflict:function(a,b,c,d){var e,f;if(!(1>=d)){var h=a.outerLabelGroupData[b].hs;if(!("clockwise"===c&&"right"!==h||"anticlockwise"===c&&"left"!==h)){var i="clockwise"===c?b+1:b-1,k=a.outerLabelGroupData[b],l=a.outerLabelGroupData[i],m={labelHeights:a.outerLabelGroupData[0].h,center:a.pieCenter,lineLength:a.outerRadius+a.options.labels.outer.pieDistance,heightChange:a.outerLabelGroupData[0].h+1};if("clockwise"===c){for(e=0;b>=e;e++)if(f=a.outerLabelGroupData[e],!j.isLabelHidden(a,e)&&g.rectIntersect(f,l)){j.adjustLabelPos(a,i,k,m);break}}else for(e=d-1;e>=b;e--)if(f=a.outerLabelGroupData[e],!j.isLabelHidden(a,e)&&g.rectIntersect(f,l)){j.adjustLabelPos(a,i,k,m);break}j.checkConflict(a,i,c,d)}}},isLabelHidden:function(a,b){var c=a.options.labels.outer.hideWhenLessThanPercentage,d=k.getPercentage(a,b,a.options.labels.percentage.decimalPlaces);return null!==c&&c>d||""===a.options.data.content[b].label},adjustLabelPos:function(a,b,c,d){var e,f,g,h;h=c.y+d.heightChange,f=d.center.y-h,e=Math.abs(d.lineLength)>Math.abs(f)?Math.sqrt(d.lineLength*d.lineLength-f*f):Math.sqrt(f*f-d.lineLength*d.lineLength),g="right"===c.hs?d.center.x+e:d.center.x-e-a.outerLabelGroupData[b].w,a.outerLabelGroupData[b].x=g,a.outerLabelGroupData[b].y=h},getIdealOuterLabelPositions:function(b,c){var d=a.select("#"+b.cssPrefix+"labelGroup"+c+"-outer").node();if(d){var e=d.getBBox(),f=k.getSegmentAngle(c,b.options.data.content,b.totalSize,{midpoint:!0}),g=b.pieCenter.x,h=b.pieCenter.y-(b.outerRadius+b.options.labels.outer.pieDistance),j=i.rotate(g,h,b.pieCenter.x,b.pieCenter.y,f),l="right";f>180?(j.x-=e.width+8,l="left"):j.x+=8,b.outerLabelGroupData[c]={x:j.x,y:j.y,w:e.width,h:e.height,hs:l}}}},k={create:function(b){var c=b.pieCenter,d=b.options.colors,e=b.options.effects.load,f=b.options.misc.colors.segmentStroke,g=b.svg.insert("g","#"+b.cssPrefix+"title").attr("transform",function(){return i.getPieTranslateCenter(c)}).attr("class",b.cssPrefix+"pieChart"),h=a.svg.arc().innerRadius(b.innerRadius).outerRadius(b.outerRadius).startAngle(0).endAngle(function(a){return a.value/b.totalSize*2*Math.PI}),j=g.selectAll("."+b.cssPrefix+"arc").data(b.options.data.content).enter().append("g").attr("class",b.cssPrefix+"arc"),l=e.speed;"none"===e.effect&&(l=0),j.append("path").attr("id",function(a,c){return b.cssPrefix+"segment"+c}).attr("fill",function(a,c){var e=d[c];return b.options.misc.gradient.enabled&&(e="url(#"+b.cssPrefix+"grad"+c+")"),e}).style("stroke",f).style("stroke-width",1).transition().ease("cubic-in-out").duration(l).attr("data-index",function(a,b){return b}).attrTween("d",function(c){var d=a.interpolate({value:0},c);return function(a){return b.arc(d(a))}}),b.svg.selectAll("g."+b.cssPrefix+"arc").attr("transform",function(a,c){var d=0;return c>0&&(d=k.getSegmentAngle(c-1,b.options.data.content,b.totalSize)),"rotate("+d+")"}),b.arc=h},addGradients:function(a){var b=a.svg.append("defs").selectAll("radialGradient").data(a.options.data.content).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",0).attr("cy",0).attr("r","120%").attr("id",function(b,c){return a.cssPrefix+"grad"+c});b.append("stop").attr("offset","0%").style("stop-color",function(b,c){return a.options.colors[c]}),b.append("stop").attr("offset",a.options.misc.gradient.percentage+"%").style("stop-color",a.options.misc.gradient.color)},addSegmentEventHandlers:function(b){var c=a.selectAll("."+b.cssPrefix+"arc,."+b.cssPrefix+"labelGroup-inner,."+b.cssPrefix+"labelGroup-outer");c.on("click",function(){var c,d=a.select(this);if(d.attr("class")===b.cssPrefix+"arc")c=d.select("path");else{var e=d.attr("data-index");c=a.select("#"+b.cssPrefix+"segment"+e)}var f=c.attr("class")===b.cssPrefix+"expanded";k.onSegmentEvent(b,b.options.callbacks.onClickSegment,c,f),"none"!==b.options.effects.pullOutSegmentOnClick.effect&&(f?k.closeSegment(b,c.node()):k.openSegment(b,c.node()))}),c.on("mouseover",function(){var c,d,e=a.select(this);if(e.attr("class")===b.cssPrefix+"arc"?c=e.select("path"):(d=e.attr("data-index"),c=a.select("#"+b.cssPrefix+"segment"+d)),b.options.effects.highlightSegmentOnMouseover){d=c.attr("data-index");var f=b.options.colors[d];c.style("fill",g.getColorShade(f,b.options.effects.highlightLuminosity))}b.options.tooltips.enabled&&(d=c.attr("data-index"),m.showTooltip(b,d));var h=c.attr("class")===b.cssPrefix+"expanded";k.onSegmentEvent(b,b.options.callbacks.onMouseoverSegment,c,h)}),c.on("mousemove",function(){m.moveTooltip(b)}),c.on("mouseout",function(){var c,d,e=a.select(this);if(e.attr("class")===b.cssPrefix+"arc"?c=e.select("path"):(d=e.attr("data-index"),c=a.select("#"+b.cssPrefix+"segment"+d)),b.options.effects.highlightSegmentOnMouseover){d=c.attr("data-index");var f=b.options.colors[d];b.options.misc.gradient.enabled&&(f="url(#"+b.cssPrefix+"grad"+d+")"),c.style("fill",f)}b.options.tooltips.enabled&&(d=c.attr("data-index"),m.hideTooltip(b,d));var g=c.attr("class")===b.cssPrefix+"expanded";k.onSegmentEvent(b,b.options.callbacks.onMouseoutSegment,c,g)})},onSegmentEvent:function(a,b,c,d){if(g.isFunction(b)){var e=parseInt(c.attr("data-index"),10);b({segment:c.node(),index:e,expanded:d,data:a.options.data.content[e]})}},openSegment:function(b,c){b.isOpeningSegment||(b.isOpeningSegment=!0,a.selectAll("."+b.cssPrefix+"expanded").length>0&&k.closeSegment(b,a.select("."+b.cssPrefix+"expanded").node()),a.select(c).transition().ease(b.options.effects.pullOutSegmentOnClick.effect).duration(b.options.effects.pullOutSegmentOnClick.speed).attr("transform",function(a,c){var d=b.arc.centroid(a),e=d[0],f=d[1],g=Math.sqrt(e*e+f*f),h=parseInt(b.options.effects.pullOutSegmentOnClick.size,10);return"translate("+e/g*h+","+f/g*h+")"}).each("end",function(d,e){b.currentlyOpenSegment=c,b.isOpeningSegment=!1,a.select(this).attr("class",b.cssPrefix+"expanded")}))},closeSegment:function(b,c){a.select(c).transition().duration(400).attr("transform","translate(0,0)").each("end",function(c,d){a.select(this).attr("class",""),b.currentlyOpenSegment=null})},getCentroid:function(a){var b=a.getBBox();return{x:b.x+b.width/2,y:b.y+b.height/2}},getSegmentAngle:function(a,b,c,d){var e,f=h({compounded:!0,midpoint:!1},d),g=b[a].value;if(f.compounded){e=0;for(var i=0;a>=i;i++)e+=b[i].value}"undefined"==typeof e&&(e=g);var j=e/c*360;if(f.midpoint){var k=g/c*360;j-=k/2}return j},getPercentage:function(a,b,c){var d=a.options.data.content[b].value/a.totalSize;return 0>=c?Math.round(100*d):(100*d).toFixed(c)}},l={offscreenCoord:-1e4,addTitle:function(a){a.svg.selectAll("."+a.cssPrefix+"title").data([a.options.header.title]).enter().append("text").text(function(a){return a.text}).attr({id:a.cssPrefix+"title","class":a.cssPrefix+"title",x:l.offscreenCoord,y:l.offscreenCoord}).attr("text-anchor",function(){var b;return b="top-center"===a.options.header.location||"pie-center"===a.options.header.location?"middle":"left"}).attr("fill",function(a){return a.color}).style("font-size",function(a){return a.fontSize+"px"}).style("font-family",function(a){return a.font})},positionTitle:function(a){var b,c=a.textComponents,d=a.options.header.location,e=a.options.misc.canvasPadding,f=a.options.size.canvasWidth,g=a.options.header.titleSubtitlePadding;b="top-left"===d?e.left:(f-e.right)/2+e.left,b+=a.options.misc.pieCenterOffset.x;var h=e.top+c.title.h;if("pie-center"===d)if(h=a.pieCenter.y,c.subtitle.exists){var i=c.title.h+g+c.subtitle.h;h=h-i/2+c.title.h}else h+=c.title.h/4;a.svg.select("#"+a.cssPrefix+"title").attr("x",b).attr("y",h)},addSubtitle:function(a){var b=a.options.header.location;a.svg.selectAll("."+a.cssPrefix+"subtitle").data([a.options.header.subtitle]).enter().append("text").text(function(a){return a.text}).attr("x",l.offscreenCoord).attr("y",l.offscreenCoord).attr("id",a.cssPrefix+"subtitle").attr("class",a.cssPrefix+"subtitle").attr("text-anchor",function(){var a;return a="top-center"===b||"pie-center"===b?"middle":"left"}).attr("fill",function(a){return a.color}).style("font-size",function(a){return a.fontSize+"px"}).style("font-family",function(a){return a.font})},positionSubtitle:function(a){var b,c=a.options.misc.canvasPadding,d=a.options.size.canvasWidth;b="top-left"===a.options.header.location?c.left:(d-c.right)/2+c.left,b+=a.options.misc.pieCenterOffset.x;var e=l.getHeaderHeight(a);a.svg.select("#"+a.cssPrefix+"subtitle").attr("x",b).attr("y",e)},addFooter:function(a){a.svg.selectAll("."+a.cssPrefix+"footer").data([a.options.footer]).enter().append("text").text(function(a){return a.text}).attr("x",l.offscreenCoord).attr("y",l.offscreenCoord).attr("id",a.cssPrefix+"footer").attr("class",a.cssPrefix+"footer").attr("text-anchor",function(){var b="left";return"bottom-center"===a.options.footer.location?b="middle":"bottom-right"===a.options.footer.location&&(b="left"),b}).attr("fill",function(a){return a.color}).style("font-size",function(a){return a.fontSize+"px"}).style("font-family",function(a){return a.font})},positionFooter:function(a){var b,c=a.options.footer.location,d=a.textComponents.footer.w,e=a.options.size.canvasWidth,f=a.options.size.canvasHeight,g=a.options.misc.canvasPadding;b="bottom-left"===c?g.left:"bottom-right"===c?e-d-g.right:e/2,a.svg.select("#"+a.cssPrefix+"footer").attr("x",b).attr("y",f-g.bottom)},getHeaderHeight:function(a){var b;if(a.textComponents.title.exists){var c=a.textComponents.title.h+a.options.header.titleSubtitlePadding+a.textComponents.subtitle.h;b="pie-center"===a.options.header.location?a.pieCenter.y-c/2+c:c+a.options.misc.canvasPadding.top}else if("pie-center"===a.options.header.location){var d=a.options.misc.canvasPadding.bottom+a.textComponents.footer.h;b=(a.options.size.canvasHeight-d)/2+a.options.misc.canvasPadding.top+a.textComponents.subtitle.h/2}else b=a.options.misc.canvasPadding.top+a.textComponents.subtitle.h;return b}},m={addTooltips:function(a){var b=a.svg.insert("g").attr("class",a.cssPrefix+"tooltips");b.selectAll("."+a.cssPrefix+"tooltip").data(a.options.data.content).enter().append("g").attr("class",a.cssPrefix+"tooltip").attr("id",function(b,c){return a.cssPrefix+"tooltip"+c}).style("opacity",0).append("rect").attr({rx:a.options.tooltips.styles.borderRadius,ry:a.options.tooltips.styles.borderRadius,x:-a.options.tooltips.styles.padding,opacity:a.options.tooltips.styles.backgroundOpacity}).style("fill",a.options.tooltips.styles.backgroundColor),b.selectAll("."+a.cssPrefix+"tooltip").data(a.options.data.content).append("text").attr("fill",function(b){return a.options.tooltips.styles.color}).style("font-size",function(b){return a.options.tooltips.styles.fontSize}).style("font-family",function(b){return a.options.tooltips.styles.font}).text(function(b,c){var d=a.options.tooltips.string;return"caption"===a.options.tooltips.type&&(d=b.caption),m.replacePlaceholders(a,d,c,{label:b.label,value:b.value,percentage:k.getPercentage(a,c,a.options.labels.percentage.decimalPlaces)})}),b.selectAll("."+a.cssPrefix+"tooltip rect").attr({width:function(b,c){var d=g.getDimensions(a.cssPrefix+"tooltip"+c);return d.w+2*a.options.tooltips.styles.padding},height:function(b,c){var d=g.getDimensions(a.cssPrefix+"tooltip"+c);return d.h+2*a.options.tooltips.styles.padding},y:function(b,c){var d=g.getDimensions(a.cssPrefix+"tooltip"+c);return-(d.h/2)+1}})},showTooltip:function(b,c){var d=b.options.tooltips.styles.fadeInSpeed;m.currentTooltip===c&&(d=1),m.currentTooltip=c,a.select("#"+b.cssPrefix+"tooltip"+c).transition().duration(d).style("opacity",function(){return 1}),m.moveTooltip(b)},moveTooltip:function(b){a.selectAll("#"+b.cssPrefix+"tooltip"+m.currentTooltip).attr("transform",function(c){var d=a.mouse(this.parentNode),e=d[0]+b.options.tooltips.styles.padding+2,f=d[1]-2*b.options.tooltips.styles.padding-2;return"translate("+e+","+f+")"})},hideTooltip:function(b,c){a.select("#"+b.cssPrefix+"tooltip"+c).style("opacity",function(){return 0}),a.select("#"+b.cssPrefix+"tooltip"+m.currentTooltip).attr("transform",function(a,c){var d=b.options.size.canvasWidth+1e3,e=b.options.size.canvasHeight+1e3;return"translate("+d+","+e+")"})},replacePlaceholders:function(a,b,c,d){g.isFunction(a.options.tooltips.placeholderParser)&&a.options.tooltips.placeholderParser(c,d);var e=function(){return function(a){var b=arguments[1];return d.hasOwnProperty(b)?d[arguments[1]]:arguments[0]}};return b.replace(/\{(\w+)\}/g,e(d))}},n=function(j,k){if(this.element=j,"string"==typeof j){var l=j.replace(/^#/,"");this.element=document.getElementById(l)}var m={};h(!0,m,e,k),this.options=m,null!==this.options.misc.cssPrefix?this.cssPrefix=this.options.misc.cssPrefix:(this.cssPrefix="p"+d+"_",d++),f.initialCheck(this)&&(a.select(this.element).attr(b,c),this.options.data.content=i.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=g.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=g.initSegmentColors(this),this.totalSize=i.getTotalPieSize(this.options.data.content),o.call(this))};n.prototype.recreate=function(){f.initialCheck(this)&&(this.options.data.content=i.sortPieData(this),this.options.data.smallSegmentGrouping.enabled&&(this.options.data.content=g.applySmallSegmentGrouping(this.options.data.content,this.options.data.smallSegmentGrouping)),this.options.colors=g.initSegmentColors(this),this.totalSize=i.getTotalPieSize(this.options.data.content),o.call(this))},n.prototype.redraw=function(){this.element.innerHTML="",o.call(this)},n.prototype.destroy=function(){this.element.innerHTML="",a.select(this.element).attr(b,null)},n.prototype.getOpenSegment=function(){var b=this.currentlyOpenSegment;if(null!==b&&"undefined"!=typeof b){var c=parseInt(a.select(b).attr("data-index"),10);return{element:b,index:c,data:this.options.data.content[c]}}return null},n.prototype.openSegment=function(b){b=parseInt(b,10),0>b||b>this.options.data.content.length-1||k.openSegment(this,a.select("#"+this.cssPrefix+"segment"+b).node())},n.prototype.closeSegment=function(){var a=this.currentlyOpenSegment;a&&k.closeSegment(this,a)},n.prototype.updateProp=function(b,c){switch(b){case"header.title.text":var d=g.processObj(this.options,b);g.processObj(this.options,b,c),a.select("#"+this.cssPrefix+"title").html(c),(""===d&&""!==c||""!==d&&""===c)&&this.redraw();break;case"header.subtitle.text":var e=g.processObj(this.options,b);g.processObj(this.options,b,c),a.select("#"+this.cssPrefix+"subtitle").html(c),(""===e&&""!==c||""!==e&&""===c)&&this.redraw();break;case"callbacks.onload":case"callbacks.onMouseoverSegment":case"callbacks.onMouseoutSegment":case"callbacks.onClickSegment":case"effects.pullOutSegmentOnClick.effect":case"effects.pullOutSegmentOnClick.speed":case"effects.pullOutSegmentOnClick.size":case"effects.highlightSegmentOnMouseover":case"effects.highlightLuminosity":g.processObj(this.options,b,c);break;default:g.processObj(this.options,b,c),this.destroy(),
this.recreate()}};var o=function(){this.svg=g.addSVGSpace(this),this.textComponents={headerHeight:0,title:{exists:""!==this.options.header.title.text,h:0,w:0},subtitle:{exists:""!==this.options.header.subtitle.text,h:0,w:0},footer:{exists:""!==this.options.footer.text,h:0,w:0}},this.outerLabelGroupData=[],this.textComponents.title.exists&&l.addTitle(this),this.textComponents.subtitle.exists&&l.addSubtitle(this),l.addFooter(this);var a=this;g.whenIdExists(this.cssPrefix+"footer",function(){l.positionFooter(a);var b=g.getDimensions(a.cssPrefix+"footer");a.textComponents.footer.h=b.h,a.textComponents.footer.w=b.w});var b=[];this.textComponents.title.exists&&b.push(this.cssPrefix+"title"),this.textComponents.subtitle.exists&&b.push(this.cssPrefix+"subtitle"),this.textComponents.footer.exists&&b.push(this.cssPrefix+"footer"),g.whenElementsExist(b,function(){if(a.textComponents.title.exists){var b=g.getDimensions(a.cssPrefix+"title");a.textComponents.title.h=b.h,a.textComponents.title.w=b.w}if(a.textComponents.subtitle.exists){var c=g.getDimensions(a.cssPrefix+"subtitle");a.textComponents.subtitle.h=c.h,a.textComponents.subtitle.w=c.w}if(a.textComponents.title.exists||a.textComponents.subtitle.exists){var d=0;a.textComponents.title.exists&&(d+=a.textComponents.title.h,a.textComponents.subtitle.exists&&(d+=a.options.header.titleSubtitlePadding)),a.textComponents.subtitle.exists&&(d+=a.textComponents.subtitle.h),a.textComponents.headerHeight=d}i.computePieRadius(a),i.calculatePieCenter(a),l.positionTitle(a),l.positionSubtitle(a),a.options.misc.gradient.enabled&&k.addGradients(a),k.create(a),j.add(a,"inner",a.options.labels.inner.format),j.add(a,"outer",a.options.labels.outer.format),j.positionLabelElements(a,"inner",a.options.labels.inner.format),j.positionLabelElements(a,"outer",a.options.labels.outer.format),j.computeOuterLabelCoords(a),j.positionLabelGroups(a,"outer"),j.computeLabelLinePositions(a),a.options.labels.lines.enabled&&"none"!==a.options.labels.outer.format&&j.addLabelLines(a),j.positionLabelGroups(a,"inner"),j.fadeInLabelsAndLines(a),a.options.tooltips.enabled&&m.addTooltips(a),k.addSegmentEventHandlers(a)})};return n});